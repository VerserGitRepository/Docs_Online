@model  DocsOnline.Models.ProjectDetailsModel
<script src="~/Scripts/jquery-3.4.1.min.js" type="text/javascript"></script>
<link href="~/Content/bootstrap.css" rel="stylesheet" />
<script src="~/Scripts/jquery-3.4.1.min.js" type="text/javascript"></script>
<link href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src=" https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap4.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script src="~/Scripts/jquery.ztree.core-3.5.js"></script>
<link href="~/Content/zTreeStyle.css" rel="stylesheet" />
@*<div class="container" style="margin-top:15px;">
    <div class="col-md-6">
        @Html.DropDownListFor(model => model.ProjectID, Model.Projectlist, "PROJECT", new { @class = "form-control project", @id = "ddlProjectId" })
    </div>
    <div class="col-md-6 ">
        @Html.Label("Upload a File", htmlAttributes: new { @class = "control-label col-md-4" })<input type="file" name="UploadResumeFile" id="ResumeFile" />      
    </div>
</div>*@
<div class="container" style="margin-top:20px;width:140%;">


    <div class="row">
        <div class="col-md-3 pull-left">
            <table id="FolderTable" class="table pull-left" data-page-length="13" style="margin-right:0px;border:solid;  font-size:16px; border-width:thin; border-color:lightgray">
                <thead style="background-color: #428bca; color:white">
                    <tr>
                        <th>Folders</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.FoldersList)
                    {
                        <tr>
                            <td>
                                @*   <p><input type="checkbox" name="check-1" value="1" class="lcs_check" autocomplete="off" /></p>*@
                                <input type="hidden" value="@item.FolderDirectory" id="hdnFolder" />
                                <a> <span class="glyphicon glyphicon-folder-close" style="padding-right:5px;" onclick="GetFolderFiles('@item.FolderName',this)" />&nbsp; @item.FolderName</a>
                                <ul id="@item.FolderName.Replace(" ","")" class="ztree" />
                                @*<a onclick="LoadFolderFiles('@item.FolderDirectory')"><span class="glyphicon glyphicon-folder-close" style="padding-right:5px;" />&nbsp; @item.FolderName</a>*@
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="col-md-7 pull-left" style="border:solid; border-width:thin; font-size:13px; border-color:lightgray" id="content">

            <table class="table pull-left" id="FilesTable" data-page-length="20">
                <thead style="background-color: #428bca; color:white">
                    <tr>
                        <th>
                            FileName
                        </th>
                        <th>
                            FileSize
                        </th>
                        <th>
                            FileType
                        </th>
                        <th>
                            FileDate
                        </th>
                    </tr>
                </thead>
                <tbody>

                    @foreach (var _file in Model.Files)
                    {
                        <tr>
                            <td>@Html.ActionLink(_file.FileName, "DownloadFile", "Projects", new { path = _file.FileFullPath, fileName = _file.FileName }, htmlAttributes: null)</td>
                            <td>@_file.FileSize</td>
                            <td>@_file.FileType</td>
                            <td>@_file.FileDate</td>
                        </tr>
                    }

                </tbody>
            </table>
        </div>
        <div class="col-md-2 pull-left">
           <div class="container table-bordered" style=width:200%>
            <h3 style="background-color: #428bca; color:white">
                Upload
            </h3>
                   
                <form action="/action_page.php">
                    <input type="file" id="myFile" name="filename">
                    <br>
                    <input type="submit">
                </form>
            
        </div>
        <div id="jstree_demo"></div>
    </div>
</div>

<script>

    $(document).ready(function () {
        $('#FolderTable').DataTable({
            responsive: true,
            stateSave: true,
            "info": false,
            pagingType: "simple",
        });
        $('#FilesTable').DataTable();
      
    });
    $.fn.DataTable.ext.pager.numbers_length = 0;
    function GetFolderFiles(FolderName, td) {

        $(td).hide();
        //  alert(FolderName);
        var trimspace = "";
        $.ajax({
            url: "./GetListOfFiles",
            type: "GET",
            data: { "FolderName": FolderName },
            beforeSend: function () {
                //  alert("testing");
            },
            success: function (result) {

                //$("#content").html(result);
                populateDataTable(JSON.parse(result.Data), FolderName, td);
                populateFilesDataTable(result.Files);
            },
            error: function (resp) {
                alert(resp);
            }
        });
    }

    function populateDataTable(zNodes, FolderName, td) {
        var row = $(td).closest("tr");
        var onj = $(row).find("ul");
        console.log("populating data table...");
        // clear the table before populating it with more data
        $("#FilesTable").DataTable().clear();
        var length = Object.keys(zNodes).length;
        if (length == 0) {
            $('#FilesTable').dataTable().fnAddData(["", "", "", ""]);
        }
        else {
            for (var i = 0; i < length; i++) {
              //  var quote = data[i];
             //   trimspace = quote.FileName.replace(/ /g, "%20");
                // You could also use an ajax property on the data table initialization

               // console.log(trimspace);

                //$('#FilesTable').dataTable().fnAddData([
                //    '<a href=/Projects/DownloadFile?fileName=' + FolderName + '\\' + trimspace + '>' + quote.FileName + '</a>' + '<br>',
                //    quote.FileSize,
                //    quote.FileType,
                //    quote.FileDate
                //]);
            }
        }
        var setting = {
            data: {
                simpleData: {
                    enable: true,
                    idKey: "id",
                    pIdKey: "pId",
                    rootPId: 0
                }
            },
            callback: {
                onClick: clickedevent
            }
        };
        $.fn.zTree.init($(onj), setting, zNodes);
    }

    function populateFilesDataTable(data) {

        $("#FilesTable").DataTable().clear();
        if (data.length == 0) {
            $('#FilesTable').dataTable().fnAddData(["", "", "", ""]);
        }
        for (var i = 0; i < data.length; i++) {
            var quote = data[i];
             // trimspace = quote.FileName.replace(/ /g, "%20");
            //console.log(trimspace);
            $('#FilesTable').dataTable().fnAddData([
                '<a href="javascript:DownloadFile(' +"'"+ quote.FileName +"'"+ ');" >' + quote.FileName + '</a>',
                quote.FileSize,
                quote.FileType,
                new Date(moment(quote.FileDate)).toLocaleDateString(),
            ]);
        }
    }
    var fullPath = "";
    function clickedevent(event, treeId, treeNode, clickFlag) {
        fullPath = "";
        GetRecursiveFilePath(treeNode);
       // alert(fullPath);
        var row = event.target.closest("tr");
        fullPath = fullPath.split("\\").reverse().join("\\");
        fullPath = $(row).find("#hdnFolder").val() + "\\" + fullPath;
        //alert(joinArray);
        LoadFolderFiles(fullPath);
    }
   
    function GetRecursiveFilePath(treeNode) {

        if (treeNode.level != 1) {
            fullPath += "\\" + treeNode.name;
            GetRecursiveFilePath(treeNode.getParentNode());
        }
        else {
            fullPath += "\\" + treeNode.name;
            return;
        }
        //return fullPath;
    }
    function LoadFolderFiles(FolderDir) {
        $.ajax({
            url: "./GetListOfFiles",
            type: "GET",
            data: { "FolderName": FolderDir },
            beforeSend: function () {
                //  alert("testing");
            },
            success: function (result) {

                //$("#content").html(result);
                //populateDataTable(JSON.parse(result.Data), FolderName, td);
                populateFilesDataTable(result.Files);
            },
            error: function (resp) {
               // alert(resp);
            }
        });

    }

    function DownloadFile(FolderDir) {
        $.ajax({
            url: "./DownloadFile",
            type: "GET",
            data: { "path": fullPath, "fileName": FolderDir },
            beforeSend: function () {
                //  alert("testing");
            },
            success: function (result) {

                window.location.href = "./DownloadFile?path="+fullPath+"&fileName="+FolderDir;
               
            },
            error: function (resp) {
                // alert(resp);
            }
        });

    }
</script>
<style>
    .container {
        padding-right: 5px;
        padding-left: 5px;
        margin-right: auto;
        margin-left: 20px;
    }

    .dataTables_paginate {
        float: left;
        text-align: right;
        padding-top: 0.25em
    }
</style>
